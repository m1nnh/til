## 라우팅과 인터넷 계층

### 인터넷 계층의 역할

`인터넷 계층`은 네트워크 인터페이스 계층과 협력하여 다른 컴퓨터에게 데이터를 전달하는 역할을 한다. 인터넷 계층은 `IP Address`라고 하는 식별자 정보를 실마리로 데이터를 전달할 수 있는 체계를 제공하도록 역할이 구분되어 있다.

- 송신지, 수신지의 컴퓨터는 IP Address로 식별할 수 있다.
- IP Address 정보를 보고 인터넷 어딘가에 연결된 컴퓨터를 찾아 데이터를 전달한다. (라우터)
- 전달 과정에서 문제가 생겨 수신지까지 전달되지 않는 경우가 발생하기도 한다.

#### 라우터와 라우팅

데이터를 목적지까지 전달하기 위해서는 `라우터(router)`라고 하는 네트워크 장비가 필요하다. 라우터는 네트워크와 네트워크를 연결하는 역할을 하는데, 하나의 라우터는 데이터를 목적지까지 전달하기 위해 다음 네트워크의 경로를 찾고, 그 경로상에 있는 라우터에게 데이터를 전달을 위임하게 된다. 이런 과정은 최종 목적지를 찾기까지 연쇄적으로 반복되는데, 이렇게 라우터가 목적지의 경로를 찾아 나가는 과정을 `라우팅(routing)`이라고 한다.

![image](https://user-images.githubusercontent.com/78870076/124383794-570f5980-dd09-11eb-8ca9-89e8c9e096aa.png)

사진 출처 : [https://dentuniverse.tistory.com/16](https://dentuniverse.tistory.com/16)

- 연결된 여러 라우터들 중 어느 족에 데이터를 보내야 목적지에 도달할지 판단한다.
- 자신이 속한 네트워크에 목적지 컴퓨터가 속해 있다면 그 컴퓨터에게 데이터를 전달한다.

### IPv4와 IPv6

`IPv4(Internet Protocol Version 4)`는 현재까지 컴퓨터의 어드레스를 지정할 때 가장 많이 사용되는 인터넷 계층의 프로토콜이다. 네트워크에 연결된 컴퓨터를 식별하기 위해 32비트의 IP Address를 사용한다. 단, 32비트 문자열은 사람이 알아보기 어렵기 때문에 전체 32비트를 8비트의 4개 단위로 끊은 후에 10진수로 변환하여 표기하고 있다.

#### IPv4 헤더

IPv4 패킷의 `IP Header`에는 송신지와 수신지의 IP Address 외에도 패킷 길이와 같은 다양한 정보들이 포함되어 있다.

![](https://www.computernetworkingnotes.org/images/ip-tutorials/it07-01-structure-of-ipv4-header.PNG)

사진 출처 : [https://www.computernetworkingnotes.com/networking-tutorials/ipv4-header-structure-and-fields-explained.html](https://www.computernetworkingnotes.com/networking-tutorials/ipv4-header-structure-and-fields-explained.html)


<center> 필드 </center> | <center> 내용 </center>
:--- | :---
Version | IPv4에서는 4 (버전)
IHL | IP 헤더의 길이
Type of Service | 패킷의 우선순위를 결정
Total Length | 패킷 전체의 길이
Identification | 같은 데이터인지 식별하기 위한 16비트 숫자 값
Flags | 분할 허가 플래그와 이후 남은 분할 부분이 더 있는지 표시하기 위한 플래그
Fragment Offset | 식별자에서 프래그먼트 옵셋까지는 데이터가 분할 된 경우 사용(원래 데이터에서의 위치 값을 표현하는 13비트 숫자 값)
Time to Live | 패킷의 생존 기간
Protocol | 트랜스포트 계층의 어느 프로토콜에 전달할지를 판단하는 번호

수신지로 지정된 컴퓨터가 실제로는 존재하지 않거나 통신 경로를 찾지 못해 패킷이 제대로 전달되지 않는 경우가 종종 발생할 수 있다. 이렇게 패킷이 목적지를 찾지 못해 네트워크 안을 계속 떠돌게 되면 네트워크가 혼잡핻질 수 있는데, 이러한 문제를 방지하기 위해 IPv4 헤더에는 `생존 기간(TTL, Time To Live)` 정보를 설정할 수 있게 되어 있고, 만약 생존 기간을 초과한 패킷이 네트워크상에서 발견되면 그 패킷을 소멸시키도록 규정하고 있다.

- 이동할 때마다 생존 기간이 줄어든다.
- 생존 기간이 지나면 전달되지 않았더라도 패킷을 소멸시킨다.

한 번에 전송할 수 있는 데이터 크기를 `MTU(Maximum Transmission Unit)`라고 하고, 이 값은 통신 경로의 상태에 따라 달라진다. 예를 들어, 경로 상태가 좋지 않으면 이 값이 줄어들게 되는데, 라우터에는 이 MTU 값에 따라 패킷을 분할해서 전송하는 기능이 구현되어 있다. 다만, 라우터의 작업 부하가 높아지거나 분할된 패킷 중의 일부가 유실되면 복원이 어려워지는 단점이 있다. 그래서 라우터가 데이터를 송신하기 전에 통신 경로 전체의 MTU를 살펴본 후 처음부터 MTU보다 작은 크기의 패킷을 만들도록 설정하기도 한다.

- 전송 가능한 크기로 라우터가 데이터를 분할한다.
- 도착하면 컴퓨터에서 분할된 데이터를 복원한다.

#### IPv6

인터넷의 급격한 성장으로 인해 IPv4의 32비트 어드레스가 머지않아 고갈될 상황에 이르렀다. 그래서 나온 것이 128비트 어드레스로 만든 `IPv6`이다.

### IP Address의 활용

IP Address는 `네트워크 부`와 `호스트 부`로 구성된다. 여기서 말하는 호스트는 네트워크에 연결된 컴퓨터나 네트워크 장비를 의미한다. 라우터는 송신지 IP Address의 네트워크 부의 정보를 보고 데이터를 송신할 목적지가 같은 네트워크 안에 있는지 다른 네트워크에 있는지를 판단하게 된다.

#### 어드레스 클래스

하나의 IP Address 안에서 어디까지가 네트워크 부이고 어디까지가 호스트 부인지 미리 그 길이를 고정하여 결정해 둔 것이 있는데, 이것을 `어드레스 클래스(Address Class)`라고 부른다.

![image](https://user-images.githubusercontent.com/78870076/124385398-58905000-dd10-11eb-854c-7dc067e6d5c9.png)

사진 출처 : [https://limkydev.tistory.com/168](https://limkydev.tistory.com/168)

클래스 A의 어드레스는 한 개의 네트워크당 약 1677만 대의 호스트의 어드레스를 할당할 수 있다. 하지만 실제로는 그렇게 많은 호스트를 하나의 네트워크에 연결하는 경우는 거의 없기 때문에 많은 수의 어드레스가 사용되지 않고 낭비된다.

#### 서브넷 마스크

어드레스 클래스는 네트워크 부의 길이가 미리 정해져 있다. 하지만 `서브넷 마스크(Subnet Mask)`를 사용하면 이 길이를 비트 단위로 유연하게 늘려서 쓰는 것이 가능하다. 서브넷 마스크는 IP Address에 추가되는 정보이므로 32비트 길이만큼의 정보가 더 필요하다. IP Address는 네트워크상에서 호스트를 식별하기 위해 사용되는데, 전체 32비트 중 네트워크 부를 제외한 호스트 부 부분만 자유롭게 할당하여 사용할 수 있다. 서브넷 마스크를 사용하면 네트워크를 더 세분화하여 서브 네트워크, 즉 `서브넷`을 만들 수 있다. 한 네트워크에 연결하고 싶은 호스트들의 규모에 맞게 적절히 서브넷을 구성하면 부서나 지사, 지역 단위와 같이 작은 네트워크들을 만들어 네트워크 운영을 보다 유연하고 효과적으로 할 수 있다.

![](https://juner417.github.io/assets/post_images/2018-03-23-network-101-ip-subnet/subnet.png)

사진 출처 : [https://juner417.github.io/blog/network-101-ip-subnet/](https://juner417.github.io/blog/network-101-ip-subnet/)

#### 서브넷 마스크의 한계

서브넷 마스크는 어드레스 클래스에서 미리 정해진 네트워크 부의 길이를 더 늘릴 수는 있지만 더 줄이지는 못한다. 그래서 서브넷을 도입하는 경우는 호스트 부가 긴 클래스  어드레스를 세분화해야 할 때 사용하는 것이 일반적이다.

#### 프라이빗 IP Address

`프라이빗 IP 어드레스`는 가정이나 사내에서 자유롭게 사용할 수 있는 어드레스다. 프라이빗 IP 어드레스는 인터넷 연결해도 외부에서 접근할 수 없기 때문에 `NAT(Network Address Tranlation)`와 같은 어드레스 변환 기술을 사용해서 퍼블릭 IP 어드레스로 변환해 주는 기법이 필요하다.

- 프라이빗 IP 어드레스는 같은 네트워크 안에서 중복만 되지 않으면 된다.
- 라우터는 프라이빗 IP 어드레스와 퍼블릭 IP 어드레스 둘 다 가지고 있다.
- 인터넷에서 접속되어야 하는 서버들은 퍼블릭 IP 어드레스가 반드시 필요하다.

#### 퍼블릭 IP Address

`퍼블릭 IP 어드레스`는 인터넷 안에서 중복되면 안 되기 때문에 `ICANN(Internet Coporation for Assigned Names and Numbers)`이나 `KRNIC(Korea Network Information Center)`과 같은 단체가 관리한다. 퍼블릭 IP는 인터넷 레지스트리를 통해 인터넷 서비스 제공자들에게 할당되고 기업이나 가정은 인터넷 서비스가 제공자가 확보한 IP 어드레스들을 빌려서 쓴다.

#### 예약된 IP Address

IP 어드레스 중에는 이미 예약된 특수 목적의 어드레스가 있다. '127.0.0.1'은 `루프백 어드레스` 혹은 `로컬 호스트`라고 부르는데, 호스트 자신을 가리킨다. 그 외에도 호스트 부의 비트를 모두 1로 설정한 어드레스는 해당 네트워크의 모든 호스트들을 의미하는 브로드캐스트 어드레스가 된다. 또한, 호스트 부의 비트가 모두 0으로 설정된 경우는 네트워크 전체를 의미하는 어드레스가 된다.

### 라우팅

인터넷에서 데이터가 목적지까지 제대로 전달되기 위해서는 라우터가 자신과 연결된 다른 라우터를 찾아나가면서 최종 목적지까지 연결되는 경로를 찾을 수 있어야 한다. 이러한 과정을 `라우팅(Routing)`이라 하고, 이때 찾은 최적의 경로를 사용해서 통신을 하게 된다. 만약 통신 경로 상에 장애가 발생하면 다음 차선책의 통신 경로를 사용하여 통신을 재개한다.

![image](https://user-images.githubusercontent.com/78870076/124385853-85ddfd80-dd12-11eb-88ba-d0564cbde7d4.png)

사진 출처 : [https://blog.daum.net/kingdom2020/6020957](https://blog.daum.net/kingdom2020/6020957)

- 가능한 한 최단 거리를 찾아 데이터를 전달한다.
- 통신 경로에 장애가 발생하면 차선책으로 다른 경로를 사용하여 데이터를 전달한다.

데이터가 전송될 경로를 찾기 위해서 네트워크상의 각 라우터는 서로 누구와 연결되어 있는지에 대한 정보를 교환한다. 이때 `라우팅 프로토콜(Routing Protocol)`이 사용되는데, 대표적인 것으로는 `BGP`, `OSPF`, `RIP` 등이 있다. 인터넷 서비스 제공자가 사용하는 규모가 큰 네트워크에서는 몇 개의 네트워크를 하나로 묶어 `자율 시스템(AS, Autonomous System)`이라는 단위로 관리한다. 네트워크의 경로 하나하나를 찾아 다니면서 이동하는 대신, AS와 같이 큰 덩어리의 접속 경로 단위로 이동하면 멀리 있는 컴퓨터와도 더 빠른 속도로 통신할 수 있다.

#### 라우팅 테이블

라우터는 내부에 저장하고 있는 `라우팅 테이블`이라는 정보를 활용하여 라우팅을 한다. 라우팅 테이블에는 목적지 호스트가 속한 네트워크 정보와 그 네트워크로 도달하기 위해 경유해야 하는 라우터의 정보가 들어있다.

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FOGx8f%2FbtqCewg628F%2FfFEDk0QqpjQlcwCUtZi860%2Fimg.png)

사진 출처 : [https://jjh347292.tistory.com/52](https://jjh347292.tistory.com/52)

#### 정적 라우팅과 동적 라우팅

라우팅 테이블을 만드는 방법은 크게 두 가지가 있는데, 네트워크 관리자가 직접 수작업으로 라우팅 테이블을 설정하는 방식을 `정적 라우팅`이라고 하고, 라우팅 프로토콜을 사용하여 자동적으로 경로 정보를 수집한 후 라우팅 테이블을 설정하는 방식을 `동적 라우팅`이라고 한다. 네트워크 간의 접속 형태가 복잡하면 정적 라우팅으로 설정하는 것이 사실상 불가능하기 때문에 대부분은 동적 라우팅을 사용한다.

인터넷에는 수많은 네트워크가 연결되어 있기 때문에 모든 네트워크의 통신 경로를 저장하는 것은 사실상 불가능하다. 그래서 한 라우터의 라우팅 테이블에 목적지의 정보가 없다면 해당 라우터보다 더 많은 정보를 가지고 있는 기본 라우터 혹은 `디폴트 라우터`에게 물어보게 된다. 이 디폴트 라우터 정보는 각 라우터마다 정적으로 설정되어 있다.

#### 동적 라우팅 알고리즘

라우팅 프로토콜에는 여러 종류가 있는데, 경로를 찾는 방식에 따라 크게 `거리 벡터형`과 `링크 상태형`의 두 가지가 많이 사용된다.

#### 거리 벡터형

`RIP(Routing Information Protocol)` 프로토콜이 사용하는 방식으로, 목적지까지의 거리를 살펴보고 짧은 경로를 선택하는 방식이다. 이때 거리는 경유하는 라우터의 수를 의미하는 `홉(hop)`의 수로 센다. 이 방식은 비교적 구상이 간단한 LAN 네트워크에 적합하다.

![](http://blog.skby.net/blog/wp-content/uploads/2019/02/1-49-768x581.png)

사진 출처 : [http://blog.skby.net/거리-벡터-라우팅-distance-vector-routing/](http://blog.skby.net/거리-벡터-라우팅-distance-vector-routing/)

AS끼리는 경로 벡터형인 `BGP(Border Gateway Protocol)`가 사용된다. 경로 벡터형은 경로의 거리 뿐만 아니라 경로 도중에 경유하는 AS 정보도 포함하여 경로 정보를 만든다.

#### 링크 상태형

`OSPF(Open Shortest PAth First)` 프로토콜이 사용하는 방식으로 네트워크의 통신 상태 정보를 `맵(map)`으로 관리하면서 상태가 가장 좋은 경로를 선택하는 방식이다. 복잡하고 변화가 잦은 네트워크 구성에 적합하다.

![](http://blog.skby.net/blog/wp-content/uploads/2019/02/1-50-768x715.png)

사진 출처 : [http://blog.skby.net/링크-상태-라우팅-link-state-routing/](http://blog.skby.net/링크-상태-라우팅-link-state-routing/)

AS(자율 시스템)안에서는 주로 링크 상태형인 `OSPF`를 사용한다. 다만, 링크 상태형은 네트워크 규모가 커지면 맵 정보를 처리하는 부하가 커질 수 있다. 따라서 네트워크를 몇 개의 영역으로 분할한 후 각 영역별로 맵을 따로 만드는 방식을 사용한다.

#### AS 번호

AS에는 IP Address처럼 16비트 혹은 32비트 길이의 AS 번호가 할당된다. AS 번호는 퍼블릭 AS 번호와 프라이빗 AS 번호로 나누어지고, 퍼블릭 AS 번호는 퍼블릭 IP 어드레스와 마찬가지로 전 세계적으로 중복되지 않도록 관리되고 있다.

### ICMP

`ICMP(Internet Control Message Protocol)` 프로토콜은 데이터 전송 중에 문제가 생길 경우 장애 상황을 통보하기 위해 사용된다. 예를 들어, 수신 측 컴퓨터가 전원이 꺼져 있어 데이터가 전달되지 못한다면 송신 측으로부터 타입 3번 ICMP 메시지가 전달된다. 송신 측은 이 메시지를 보고 데이터가 수신 측까지 전달되지 않았다는 것을 파악하고 적절한 처리를 하게 된다.

<center> 타입 </center> | <center> 의미 </center>
:--- | :---
0 | 에코 응답, 수신 측 장비가 존재한다고 확인해 줄 때 사용한다.
3 | 데이터가 도착하지 않았다.
4 | 회선 상태가 혼잡하다.
5 | 경로 상태가 최적이 아니다.
8 | 에코 요청. 수신 측 장비가 존재하는지 확인할 때 사용한다.
9 | 라우터가 보내는 응답으로, 네트워크에 새로 연결된 장비에게 사용 가능한 라우터 정보를 알려주기 위해 사용한다.
10 | 장비가 보내는 요청으로, 네트워크에 새로 연결되었을때 라우터를 찾기 위해 사용한다.
11 | 생존 기간이 지난 패킷을 삭젷랬음을 알려준다.

### 어드레스 변환

가정이나 사무실의 네트워크에서는 보통 프라이빗 IP 어드레스를 사용한다. 이 주소는 내부에서 사용하는 가상의 주소라서 인터넷에 연결된 퍼블릭 IP 어드레스를 사용하는 서버와의 통신은 불가능하다. 그래서 이때 `네트워크 어드레스 변환(NAT, Network Address Translation)` 기술이 사용된다.

- 송신할 때는 송신지의 프라이빗 IP 어드레스를 라우터의 퍼블릭 IP 어드레스로 바꿔서 데이터를 보낸다.
- 수신할 때는 라우터의 퍼블릭 IP 어드레스를 송신지의 프라이빗 IP 어드레스로 다시 바꿔 보낸다.

NAT은 단순히 IP 어드레스를 변환할 뿐이다. 그래서 몇 가지 상황에서는 제약이 발생할 수 있다. 우선, 내부의 여러 호스트가 공교롭게 같은 포트 번호를 사용하고 있다면 라우터는 이 요청에 대한 응답을 어느 호스트에게 되돌려 보내야 하는지 포트만 보고는 판단하지 못한다. 또, 내부에서 보낸 요청에 대한 응답은 받을 수 있지만 외부에서 일방적으로 보낸 데이터는 NAT 범위 안에 있는 호스트로 전달되지 않는다.

#### 네트워크 어드레스 포트 변환

위의 제약 사항과 같이 NAT의 포트 번호 충돌을 막기 위해 만들어진 방식이 `네트워크 어드레스 포트 변환(NAPT, Network Address Port Tranlation)`이다. 이 방식은 IP 어드레스뿐만 아니라 포트 번호도 함께 변환한다. 내부 네트워크에서 프라이빗 IP를 사용하는 여러 호스트가 같은 포트 번호를 사용하고 있다면, 외부와 통신할 때 포트 번호가 충돌 나지 않도록 변환해서 요청을 보낸 호스트를 구분할 수 있도록 한다.

#### 포트포워딩

LAN 안에 웹 서버나 FTP 서버를 운영하면서 외부로 이 서비스를 공개해야 할 때가 있다. 이때 라우터의 특정 포트 번호로 통신이 들어오면 내부의 특정 서버에 전달되도록 설정할 수 있는데, 이 방법을 `포트 포워딩`이라고 한다.

![](https://user-images.githubusercontent.com/46131688/104481768-81f5dc00-5609-11eb-9741-8b20d030ded9.png)

### 도메인명

서로 다른 컴퓨터를 구분하는 식별자로는 IP 어드레스와 호스트명이 있는데, 이들 정보를 관리 하기 위해 `DNS(Domain Name System)`와 `도메인명`이라는 것이 만들어졌다. 주의할 것은 도메인의 표현 방식이 호스트명을 계층적인 형태로 표현하고 있으나, 실제로는 단순히 분류 체계의 성격으로 표현하고 있을 뿐 실제 네트워크 구성 형태가 계층적이라는 의미는 아니다.

```
http://www.sample.co.kr/
```
- www : 호스트
- sample.co.kr : 도메인명
- 호스트 + 도메인명 = IP Address

![image](https://user-images.githubusercontent.com/78870076/124386772-ecfdb100-dd16-11eb-9367-614d73d4246f.png)

사진 출처 : [http://wiki.hash.kr/index.php/네임서버](http://wiki.hash.kr/index.php/네임서버)

#### 도메인의 계층 구조

도메인명은 계층 구조 형태를 마침표로 구분하여 표현한다. 가장 뒤에 나오는 'kr'이나 'com'과 같은 도메인이 상위 도메인에 해당하고, 최상위 도메인 혹은 `탑 레벨 도메인`이라고 부른다. 탑 레벨 도메인의 하위 도메인은 `2단계 도메인` 혹은 `서브 도메인`이라고 부른다.

![image](https://user-images.githubusercontent.com/78870076/124386863-51b90b80-dd17-11eb-90fe-eaac56411a73.png)

사진 출처 : [https://nayana-blog.tistory.com/179](https://nayana-blog.tistory.com/179)

DNS 서버는 크게 도메인명을 관리하는 `콘텐츠 서버`와 질의에 응답하기 위한 `캐시 서버`의 두 종류로 구분된다. DNS 캐시 서버는 루트 네임 서버로부터 순차적으로 질의하게 되고, 질의 결과로 IP 어드레스를 알게 되면 그 내용을 요청한 클라이언트에게 응답하게 된다. 한번 질의한 내용은 캐시로 보관되기 때문에 이후 같은 질의가 들어오면 콘텐츠 서버까지 가지 않고 바로 IP 어드레스를 알려줄 수 있다.

### DHCP

TCP/IP가 제대로 동작하기 위해서는 네트워크에 속한 각 호스트의 IP 어드레스가 중복되지 않아야 한다. 네트워크의 호스트들에 대해 IP 어드레스를 할당하고 중복되지 않게 관리하는 작업을 사람이 직접 해야 할 경우 상당히 번거로울 수가 있는데, 이것을 자동으로 해 주는 것이 바로 `DHCP(Dynamic Host Configuration Protocol)`이다. 이 방식을 사용하면 호스트가 네트워크에 연결될 때 IP 어드레스와 서브넷 마스크 등의 정보가 자동으로 설정된다.

네트워크에 새로운 호스트가 연결된 직후에는 아직 IP 어드레스가 할당되지 않은 상태이고 DHCP 서버의 IP 어드레스조차 모르는 상태이므로 특정 호스트와 통신하는 것은 사실상 불가능하다. 그래서 신규 호스트는 네트워크의 모든 호스트에게 브로드캐스트 방식으로 `DHCP 발견 메시지`를 보내고, 이 메시지를 받은 DHCP 서버가 사용 가능한 IP 어드레스를 알려주는 방식으로 자동 할당이 이루어진다. 단, 이때의 신규 호스트는 아직 IP 어드레스가 할당된 상태가 아니라서 DHCP 서버가 신규 호스트에만 선택적으로 IP 어드레스 정보를 알려주진 못한다. 그래서 DHCP 서버도 브로드캐스트 방식으로 네트워크 내의 모든 호스트에게 사용 가능한 IP 어드레스를 알려주게 된다.
